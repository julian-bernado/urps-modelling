```{R message=FALSE, warning=FALSE}
source("~/urps-modelling/scripts/Z_helpers.R")

library(readr)
library(dplyr)
library(lme4)
library(purrr)
library(ggplot2)
library(stringr)
library(splines)
data <- read_csv("/home/rstudio/TEA_2019.csv")

df <- create_dataset(data)
dfs <- clean_dataset(df)

c_mod_list <- create_candidate_mod_list()
colnames(dfs[["df_3_r"]])


candidate_vars <- c("frl_ever",
                    "lep_ever",
                    "attend_p0_d1",
                    "specialed_ever",
                    "transferred_out_p0",
                    "enrfay_school",
                    "chronic_absentee_p0",
                    "homeless_ever",
                    "persist_inferred_p0",
                    "migrant_ever")

fixed_vars <- c("readng_scr_m1",
                "gender",
                "raceth")

start_time <- Sys.time()
create_candidate_mod(candidate_vars, fixed_vars, "r", 4)
end_time <- Sys.time()

print(end_time - start_time)
```

```{R}
aic_values <- map_dbl(c_mod_list[["c_mod_4_r"]], AIC)
bic_values <- map_dbl(c_mod_list[["c_mod_4_r"]], BIC)
mse_values <- map_dbl(c_mod_list[["c_mod_4_r"]], function(model) {
  preds <- predict(model)
  truth <- model@frame[[1]]
  mean((preds - truth)^2)
})

# Combine everything nicely into a tibble
comparison_table <- tibble(
  model_id = seq_along(c_mod_list[["c_mod_4_r"]]),
  AIC = aic_values,
  BIC = bic_values,
  MSE = mse_values
)

# Sort by AIC (best models first)
comparison_table %>% arrange(AIC)
comparison_table %>% arrange(BIC)
comparison_table %>% arrange(MSE)
comparison_table
```

# AIC top 10
# 968, 1013, 1014, 1023, 848, 969, 970, 1015, 858, 978

# BIC top 10
# 848, 968, 643, 858, 969, 970, 1013,1014,859, 860

# MSE top 10
# 1014, 1023, 968, 1013, 970, 1015, 848, 969, 1018, 978

# We choose 968
968	1329623	1329757	9778.403

readng_scr_p0 ~ readng_scr_m1 + gender + raceth + 
frl_ever + lep_ever + attend_pO_d1 + specialed_ever + transferred_out_pO + enrfay_school + chronic_absentee_p0 + homeless_ever 

```{R}
best_model_id <- comparison_table$model_id[which.min(comparison_table$AIC)]
best_model <- c_mod_list[["c_mod_4_r"]][[best_model_id]]
summary(best_model)
```
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)

# comparison_table should look like:
# model_id | AIC | BIC | MSE

# Step 1: No need to arrange or mutate rank
# Just pivot longer
plot_data <- comparison_table %>%
  pivot_longer(cols = c(AIC, BIC, MSE), names_to = "metric", values_to = "value")
plot_aic <- plot_data %>%
  filter(metric == "AIC") %>%
  ggplot(aes(x = model_id, y = value)) +
  geom_line(color = "steelblue") +
  geom_point(color = "steelblue") +
  labs(
    title = "AIC across Models",
    x = "Model ID",
    y = "AIC Value"
  ) +
  theme_minimal()
plot_aic
plot_mse <- plot_data %>%
  filter(metric == "MSE") %>%
  ggplot(aes(x = model_id, y = value)) +
  geom_line(color = "forestgreen") +
  geom_point(color = "forestgreen") +
  labs(
    title = "MSE across Models",
    x = "Model ID",
    y = "MSE Value"
  ) +
  theme_minimal()
plot_mse
```