```{R message=FALSE, warning=FALSE}
source("~/urps-modelling/scripts/Z_helpers.R")

library(readr)
library(dplyr)
library(lme4)
library(purrr)
library(ggplot2)
library(stringr)
library(splines)
data <- read_csv("/home/rstudio/TEA_2019.csv")

df <- create_dataset(data)
dfs <- clean_dataset(df)

c_mod_list <- create_candidate_mod_list()

candidate_vars <- c("frl_ever",
                    "lep_ever",
                    "attend_p0_d1",
                    "specialed_ever",
                    "transferred_out_p0",
                    "enrfay_school",
                    "chronic_absentee_p0",
                    "homeless_ever",
                    "persist_inferred_p0",
                    "migrant_ever")

fixed_vars <- c("readng_scr_m1",
                "gender",
                "raceth")

start_time <- Sys.time()
create_candidate_mod(candidate_vars, fixed_vars, "r", 5)
end_time <- Sys.time()
print(end_time - start_time)
```

```{R}
aic_values <- map_dbl(c_mod_list[["c_mod_5_r"]], AIC)
bic_values <- map_dbl(c_mod_list[["c_mod_5_r"]], BIC)
mse_values <- map_dbl(c_mod_list[["c_mod_5_r"]], function(model) {
  preds <- predict(model)
  truth <- model@frame[[1]]
  mean((preds - truth)^2)
})

# Combine everything nicely into a tibble
comparison_table <- tibble(
  model_id = seq_along(c_mod_list[["c_mod_5_r"]]),
  AIC = aic_values,
  BIC = bic_values,
  MSE = mse_values
)

comparison_table <- comparison_table %>%
  mutate(
    rank_aic = rank(AIC, ties.method = "first"),   # smaller AIC = better
    rank_bic = rank(BIC, ties.method = "first"),   # smaller BIC = better
    rank_mse = rank(MSE, ties.method = "first")    # smaller MSE = better
  )
comparison_table <- comparison_table %>%
  mutate(mean_rank = (rank_aic + rank_bic + rank_mse) / 3)

comparison_table %>%
  arrange(mean_rank)
```
# AIC
# 1014, 968, 1023, 1013, 970, 848, 1015, 969, 972, 849

# BIC
# 387, 638, 643, 644, 848, 646, 645, 849, 851, 858

# MSE
# 1023, 1014, 1013, 968, 1015, 1018, 970, 979, 969, 978

# BEST 848
848	975857.6	975978.7	8401.287	

readng_scr_p0 ~ readng_scr_m1 + gender + raceth + 
frl_ever +  lep_ever + attend_p0_d1 + specialed_ever + transferred_out_p0 +  
    enrfay_school + chronic_absentee_p0 + (1 | schoolid_nces_enroll_p0)
    
968	975856.2	975986.6	8401.075	2	14	4	6.666667
848	975857.6	975978.7	8401.287	6	5	11	7.333333
970	975857.2	975987.6	8401.177	5	16	7	9.333333
1014	975855.8	975995.5	8400.968	1	26	2	9.666667
1013	975857.1	975996.8	8401.026	4	27	3	11.333333
969	975858.5	975988.9	8401.238	8	18	9	11.666667
1023	975856.6	976005.7	8400.918	3	32	1	12.000000
849	975860.3	975981.4	8401.585	10	8	20	12.666667
858	975862.1	975983.2	8401.323	16	10	12	12.666667
1015	975858.0	975997.7	8401.127	7	29	5	13.666667

